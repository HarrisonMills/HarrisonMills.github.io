<!DOCTYPE html>
<html lang="en">


<!--The head contains metadata about our page and it's the place where we can load css files (for -->
<!--styling) and javascript files.-->
<head>

    <meta name="author" content="Stephan Risi">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Load JQuery and Bootstrap. They are javascript library that handle the layouting for us.-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <!-- The nav bar remains the same for every page, so by defining it in only one file, we only
     need to edit it in one place when we make changes to it. -->
    <script> $(function(){$("#header").load("header.html");});</script>

    <!-- Import the css file, which defines how our website looks -->
    <link href="css/main.css" rel="stylesheet">

    <!--Set the title for the page-->
    <title>Editing the Website</title>

</head>


<!--We define the elements that we actually want to display in the body element-->
<body>

    <!--This element is a placeholder for the header with the navbar, which we load above-->
    <div id="header"></div>

    <div class="column">

/* --------------------------------------------------------------
   Application: Flight-Control / Pilot-Training Simulator Prototype
   Class: Real Time Systems – Fall 2025
   Author: Harrison Mills
   Email: ha934819@ucf.edu
   Company Context: Lockheed Martin Missiles & Fire Control (Orlando)
   AI Use: Used for role mapping to aerospace use-cases, 
           ISR refactoring, timing/deadline annotations,
           and FreeRTOS synchronization redesign.
   Theme: F-35 Flight-Control & Training Simulator

   SYSTEM SUMMARY (Wokwi Prototype)
   --------------------------------------------------------------
   - Control Stick ADC Task (Hard) – samples stick position every 100ms
   - HOTAS Trigger ISR (Hard) – external interrupt for “pilot fired weapon”
   - Flight-Control Integrator Task (Hard) – feeds flight model & LED warning
   - Telemetry Logger Task (Soft) – UART prints sim state to “ground station”
   - Heartbeat Task (Soft) – blinks LED to show scheduler health
   - Uses mutex, binary sem, counting sem, task notifications
   - UART represents external comms to instructor / training console
   --------------------------------------------------------------*/

#include <stdio.h>
#include <stdbool.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/semphr.h"
#include "driver/gpio.h"
#include "driver/adc.h"
#include "esp_adc_cal.h"
#include "esp_log.h"

/* --------------------------------------------------------------
   HARDWARE (Wokwi)
   -------------------------------------------------------------- */
#define RED_LED      GPIO_NUM_26  // WARNING / ALERT
#define GREEN_LED    GPIO_NUM_2   // HEARTBEAT
#define HOTAS_TRIGGER_PIN GPIO_NUM_4  // ISR button
#define ADC_CH       ADC1_CHANNEL_4   // GPIO34 – Stick Y-axis

/* --------------------------------------------------------------
   TIMING REQUIREMENTS (Aerospace context)
   -------------------------------------------------------------- */
#define STICK_POLL_MS        100   // Hard periodic
#define TRIGGER_DEBOUNCE_MS   50   // ISR debounce
#define LED_ALERT_BLINK_MS   200
#define LED_ALERT_COUNT       6
#define TELEMETRY_PERIOD_MS  250   // Soft deadline

/* --------------------------------------------------------------
   RTOS OBJECTS
   -------------------------------------------------------------- */
static SemaphoreHandle_t stickCountingSem = NULL;   // Counting sem → stick threshold exceeded
static SemaphoreHandle_t triggerBinarySem = NULL;   // ISR → HOTAS trigger
static SemaphoreHandle_t uart_mutex = NULL;         // Protect UART prints

static TaskHandle_t flightControlHandle = NULL;

/* --------------------------------------------------------------
   SHARED STATE
   -------------------------------------------------------------- */
typedef enum { MODE_TRAINING = 0, MODE_COMBAT } fc_mode_t;
static fc_mode_t flight_mode = MODE_TRAINING;

static int last_stick_raw = 0;

/* --------------------------------------------------------------
   ADC Calibration
   -------------------------------------------------------------- */
static esp_adc_cal_characteristics_t adc_chars;

/* UART-safe print */
#define SAFE_PRINT(fmt, ...) \
    do { \
        xSemaphoreTake(uart_mutex, portMAX_DELAY); \
        printf(fmt, ##__VA_ARGS__); fflush(stdout); \
        xSemaphoreGive(uart_mutex); \
    } while (0)

/* ==============================================================
   HEARTBEAT TASK (SOFT)
   - Shows that the flight computer scheduler is alive
   ==============================================================*/
void heartbeat_task(void *pv)
{
    bool on = true;
    while (1) {
        gpio_set_level(GREEN_LED, on);
        on = !on;
        vTaskDelay(pdMS_TO_TICKS(500)); // 1 Hz
    }
}

/* ==============================================================
   CONTROL STICK ADC TASK (HARD)
   - Reads pilot stick every 100ms (flight model input)
   ==============================================================*/
void stick_task(void *pv)
{
    adc1_config_width(ADC_WIDTH_BIT_12);
    adc1_config_channel_atten(ADC_CH, ADC_ATTEN_DB_11);

    esp_adc_cal_characterize(ADC_UNIT_1, ADC_ATTEN_DB_11,
                             ADC_WIDTH_BIT_12, 1100, &adc_chars);

    while (1) {
        int raw = adc1_get_raw(ADC_CH);
        last_stick_raw = raw;

        SAFE_PRINT("[STICK] raw=%d\n", raw);

        if (raw > 3000) {  // extreme pull (sim → high-G yank)
            xSemaphoreGive(stickCountingSem);
            xTaskNotifyGive(flightControlHandle);
        }

        vTaskDelay(pdMS_TO_TICKS(STICK_POLL_MS));  // Hard period
    }
}

/* ==============================================================
   HOTAS TRIGGER INTERRUPT (HARD)
   ==============================================================*/
static void IRAM_ATTR hotas_isr(void *arg)
{
    static uint32_t last = 0;
    uint32_t now = xTaskGetTickCountFromISR();

    if (now - last > pdMS_TO_TICKS(TRIGGER_DEBOUNCE_MS)) {
        xSemaphoreGiveFromISR(triggerBinarySem, NULL);
        vTaskNotifyGiveFromISR(flightControlHandle, NULL);
    }
    last = now;
}

/* ==============================================================
   FLIGHT CONTROL INTEGRATOR (HARD)
   - Responds to stick threshold events + HOTAS trigger
   ==============================================================*/
void flight_control_task(void *pv)
{
    while (1) {
        ulTaskNotifyTake(pdTRUE, portMAX_DELAY);

        /* ---- Stick events ---- */
        if (uxSemaphoreGetCount(stickCountingSem) > 0) {
            while (xSemaphoreTake(stickCountingSem, 0) == pdTRUE) {}

            SAFE_PRINT("[FC] EXTREME STICK INPUT: triggering G-limit alert\n");

            // Blink LED to simulate pilot warning
            for (int i = 0; i < LED_ALERT_COUNT; i++) {
                gpio_set_level(RED_LED, 1);
                vTaskDelay(pdMS_TO_TICKS(LED_ALERT_BLINK_MS));
                gpio_set_level(RED_LED, 0);
                vTaskDelay(pdMS_TO_TICKS(LED_ALERT_BLINK_MS));
            }
        }

        /* ---- HOTAS trigger events ---- */
        if (xSemaphoreTake(triggerBinarySem, 0) == pdTRUE) {
            flight_mode = (flight_mode == MODE_TRAINING)
                          ? MODE_COMBAT
                          : MODE_TRAINING;

            const char *mode = (flight_mode == MODE_TRAINING)
                               ? "TRAINING"
                               : "COMBAT";

            SAFE_PRINT("[FC] HOTAS Trigger: mode -> %s\n", mode);
        }
    }
}

/* ==============================================================
   TELEMETRY LOGGER (SOFT)
   - Sends current sim state to instructor console (UART)
   ==============================================================*/
void telemetry_task(void *pv)
{
    while (1) {
        SAFE_PRINT("[TELEM] mode=%s  stick=%d\n",
                   (flight_mode == MODE_TRAINING ? "TRAINING" : "COMBAT"),
                   last_stick_raw);

        vTaskDelay(pdMS_TO_TICKS(TELEMETRY_PERIOD_MS));  // Soft deadline
    }
}

/* ==============================================================
   MAIN ENTRY
   ==============================================================*/
void app_main(void)
{
    printf("\n--- F-35 Flight-Control Simulator Booting ---\n");

    stickCountingSem = xSemaphoreCreateCounting(10, 0);
    triggerBinarySem = xSemaphoreCreateBinary();
    uart_mutex        = xSemaphoreCreateMutex();

    gpio_reset_pin(RED_LED);
    gpio_set_direction(RED_LED, GPIO_MODE_OUTPUT);

    gpio_reset_pin(GREEN_LED);
    gpio_set_direction(GREEN_LED, GPIO_MODE_OUTPUT);

    // HOTAS → GPIO interrupt
    gpio_reset_pin(HOTAS_TRIGGER_PIN);
    gpio_set_direction(HOTAS_TRIGGER_PIN, GPIO_MODE_INPUT);
    gpio_set_pull_mode(HOTAS_TRIGGER_PIN, GPIO_PULLUP_ONLY);
    gpio_set_intr_type(HOTAS_TRIGGER_PIN, GPIO_INTR_NEGEDGE);
    gpio_install_isr_service(0);
    gpio_isr_handler_add(HOTAS_TRIGGER_PIN, hotas_isr, NULL);

    // Create RTOS tasks
    xTaskCreate(heartbeat_task,  "heartbeat", 2048, NULL, 1, NULL);   // soft
    xTaskCreate(stick_task,      "stick",     3072, NULL, 4, NULL);   // hard
    xTaskCreate(flight_control_task,"fc",      4096, NULL, 3, &flightControlHandle); // hard
    xTaskCreate(telemetry_task,  "telemetry", 2048, NULL, 2, NULL);   // soft

    SAFE_PRINT("System initialized. Mode=TRAINING\n");
}

    </div>

</body>
